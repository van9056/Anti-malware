package antimalware.scanner.util;

import antimalware.scanner.data.scan.IObjectContent;
import antimalware.scanner.data.scan.ScanObject;
import antimalware.scanner.data.scan.ScanRegion;

import java.nio.ByteBuffer;
import java.nio.ByteOrder;
import java.util.ArrayList;
import java.util.List;

public class PEScanObjectBuilder {

    private final String HEADER = "MZ";      // Заголовок PE файла
    private final int NT_HEADER_SIGNATURE = 17744;
    private IObjectContent objectContent;

    public PEScanObjectBuilder(IObjectContent objectContent) {
        this.objectContent = objectContent;
    }

    public ScanObject getScanObject() {
        ByteBuffer headerBytes = ByteBuffer.allocate(2);
        objectContent.readBlock(0, headerBytes);
        String header = new String(headerBytes.array());
        if (header.equals(HEADER) && getNtHeaderSignature(getNtHeaderOffset()) == NT_HEADER_SIGNATURE) {
            List<ScanRegion> scanRegions = createScanRegions();
            return new ScanObject(objectContent, scanRegions, null);
        }
        return null;
    }

    private int getNtHeaderOffset() {
        ByteBuffer byteBuffer = ByteBuffer.allocate(4);
        byteBuffer.order(ByteOrder.LITTLE_ENDIAN);
        objectContent.readBlock(0x3C, byteBuffer);
        return byteBuffer.getInt();
    }

    private int getNtHeaderSignature(int NtHeaderOffset) {
        ByteBuffer byteBuffer = ByteBuffer.allocate(4);
        byteBuffer.order(ByteOrder.LITTLE_ENDIAN);
        objectContent.readBlock(NtHeaderOffset, byteBuffer);
        return byteBuffer.getInt();
    }

    private int getNumberOfSections(int NtHeaderOffset) {
        ByteBuffer byteBuffer = ByteBuffer.allocate(2);
        byteBuffer.order(ByteOrder.LITTLE_ENDIAN);
        objectContent.readBlock(NtHeaderOffset + 0x06, byteBuffer);
        byte[] bytes = { 0, 0, 0, 0 };
        bytes[2] = byteBuffer.get(1);
        bytes[3] = byteBuffer.get(0);
        return ByteBuffer.wrap(bytes).getInt();
    }

    private int getSectionsOffset() {
        return getNtHeaderOffset() + getSizeOfOptionalHeader() + 0x04 + 0x14;
    }

    private int getSizeOfOptionalHeader() {
        ByteBuffer byteBuffer = ByteBuffer.allocate(2);
        byteBuffer.order(ByteOrder.LITTLE_ENDIAN);
        objectContent.readBlock(getNtHeaderOffset() + 0x14, byteBuffer);
        byte[] bytes = { 0, 0, 0, 0 };
        bytes[2] = byteBuffer.get(1);
        bytes[3] = byteBuffer.get(0);
        return ByteBuffer.wrap(bytes).getInt();
    }

    // Создание ScanRegion'ов на основе .text и .data сегментов
    private List<ScanRegion> createScanRegions() {
        List<ScanRegion> scanRegions = new ArrayList<>();
        for (int i = 0; i < getNumberOfSections(getNtHeaderOffset()); i++) {
            int localOffset = getSectionsOffset() + (i * 0x28);
            String sectionName = getSectionName(localOffset);
            if (sectionName.equalsIgnoreCase(".text") || sectionName.equalsIgnoreCase(".data")) {
                //System.out.println(sectionName);
                int offset = getPointerToRawData(localOffset);
                int size = getSizeOfRawData(localOffset);
                ScanRegion region = new ScanRegion(objectContent, offset, size, 65536);
                scanRegions.add(region);
            }
        }
        return scanRegions;
    }

    private String getSectionName(int sectionOffset) {
        ByteBuffer byteBuffer = ByteBuffer.allocate(8);
        byteBuffer.order(ByteOrder.LITTLE_ENDIAN);
        objectContent.readBlock(sectionOffset, byteBuffer);
        return new String(byteBuffer.array()).replaceAll(String.valueOf((char) 0x00), "");
    }

    private int getSizeOfRawData(int sectionsOffset) {
        ByteBuffer byteBuffer = ByteBuffer.allocate(4);
        byteBuffer.order(ByteOrder.LITTLE_ENDIAN);
        objectContent.readBlock(sectionsOffset + 0x10, byteBuffer);
        return byteBuffer.getInt();
    }

    private int getPointerToRawData(int sectionsOffset) {
        ByteBuffer byteBuffer = ByteBuffer.allocate(4);
        byteBuffer.order(ByteOrder.LITTLE_ENDIAN);
        objectContent.readBlock(sectionsOffset + 0x14, byteBuffer);
        return byteBuffer.getInt();
    }
}
