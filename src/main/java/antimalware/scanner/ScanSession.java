package antimalware.scanner;

import antimalware.database.IDatabase;
import antimalware.database.data.Suspect;
import antimalware.scanner.data.report.ScanReport;
import antimalware.scanner.data.scan.ScanObject;
import antimalware.scanner.data.scan.ScanRegion;

import java.util.*;

public class ScanSession {

    private static ScanSession scanSession = null;
    private ScanObject scanObject;
    private IDatabase database;
    private ScanReport scanReport;
    private boolean stop = false;

    public ScanSession(ScanObject scanObject, IDatabase database, Initiator initiator) {
        this.scanObject = scanObject;
        this.database = database;
        this.scanReport = new ScanReport(initiator);
    }

    /*public void start() {
        synchronized (queue) {
            if (queue.size() == 0) {
                thread.start();
            }
            queue.add(thread);
        }
    }*/

    public ScanReport start() {
        if (scanSession == null) {
            scanSession = this;
            scan(scanObject);
        }
        return scanReport;
    }

    //TODO: Реализовать pause()
    /*public void pause() {
        pause = true;
    }*/

    /*public void stop() {
        synchronized (queue) {
            thread.interrupt();
            queue.poll();
            if (queue.size() > 0) {
                queue.peek().start();
            }
        }
    }*/

    public ScanReport stop() {
        if (scanSession != null) {
            stop = true;
        }
        return scanReport;
    }

    /*
    private void scan(ScanObject scanObject) {
        ScanReport scanReport = new ScanReport(Initiator.USER);
        scanReport.setStartDate(new Date());
        Queue<ScanRegion> scanRegions = createQueue(scanObject);
        for (ScanRegion scanRegion : scanRegions) {
            ScanEngine scanEngine = new ScanEngine(database, scanRegion, scanReport);
            scanEngine.scan();
        }
        scanReport.setStopDate(new Date());
        System.out.println(scanReport);
    }*/

    private void scan(ScanObject scanObject) {
        scanReport.setStartDate(new Date());
        List<ScanRegion> scanRegions = scanObject.getScanRegions();
        if (scanRegions != null && scanRegions.size() > 0) {
            for (ScanRegion nextScanRegion : scanRegions) {
                if (stop) break;
                List<Suspect> suspects = new ScanEngine(database, nextScanRegion).scan();
                if (suspects != null && suspects.size() > 0) {
                    scanReport.addSuspects(scanObject, suspects);
                }
            }
        }
        List<ScanObject> scanObjects = scanObject.getScanObjects();
        if (scanObjects != null && scanObjects.size() > 0) {
            for (ScanObject nextScanObject : scanObjects) {
                if (stop) break;
                scan(nextScanObject);
            }
        }
        scanReport.setStopDate(new Date());
    }

    /*
    private Queue<ScanRegion> createQueue(ScanObject scanObject) {
        Queue<ScanRegion> queue = new LinkedList<>();
        List<ScanObject> scanObjects = scanObject.getScanObjects();
        List<ScanRegion> scanRegions = scanObject.getScanRegions();
        if (scanObjects != null) {
            for (ScanObject nextScanObject : scanObjects) {
                queue.addAll(createQueue(nextScanObject));
            }
        } else if (scanRegions != null) {
            queue.addAll(scanRegions);
        }
        return queue;
    }*/
}
