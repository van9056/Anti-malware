package antimalware.scanner;

import antimalware.database.IDatabase;
import antimalware.scanner.data.report.ScanReport;
import antimalware.scanner.data.scan.FileObjectContent;
import antimalware.scanner.data.scan.ScanObject;
import antimalware.scanner.util.ScanObjectBuilder;

import java.io.File;
import java.util.*;

public class ScanSession {

    private static ScanSession scanSession = null;
    private IDatabase database;
    private ScanReport scanReport;
    private ScanObject scanObject;
    private boolean stop = false;

    public ScanSession(Directory directory, IDatabase database, Initiator initiator) {
        this.database = database;
        this.scanReport = new ScanReport(initiator);
        this.scanObject = initScanObject(directory);
    }

    public ScanSession(FileObjectContent fileObjectContent, IDatabase database, Initiator initiator) {
        this.database = database;
        this.scanReport = new ScanReport(initiator);
        this.scanObject = initScanObject(fileObjectContent);
    }

    private ScanObject initScanObject(Directory directory) {
        File dir = directory.getDirectory();
        List<ScanObject> scanObjects = new ArrayList<>();
        File[] content = dir.listFiles();
        if (content != null && content.length > 0) {
            for (File file : content) {
                if (file.isDirectory()) {
                    scanObjects.add(initScanObject(new Directory(file)));
                } else if (file.isFile()) {
                    scanObjects.add(new ScanObjectBuilder(new FileObjectContent(file)).getScanObject());
                }
            }
        }
        return new ScanObject(new FileObjectContent(directory.getDirectory()), null, scanObjects);
    }

    private ScanObject initScanObject(FileObjectContent fileObjectContent) {
        return new ScanObjectBuilder(fileObjectContent).getScanObject();
    }

    public ScanReport start() {
        if (scanSession == null) {
            scanSession = this;
            scanReport.setStartDate(new Date());
            new ScanEngine(scanObject, database, scanReport).start();
            scanReport.setStopDate(new Date());
        }
        return stop();
    }

    public ScanReport stop() {
        if (scanSession != null) {
            scanSession = null;
            stop = true;
        }
        return scanReport;
    }
}
