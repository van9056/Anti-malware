package antimalware;

import antimalware.database.Database;
import antimalware.database.FileSystemGateway;
import antimalware.database.IDatabase;
import antimalware.database.IFileSystemGateway;
import antimalware.scanner.*;
import antimalware.scanner.data.report.ScanReport;
import antimalware.scanner.data.scan.FileObjectContent;
import antimalware.scanner.data.scan.ScanObject;

import java.io.*;
import java.util.Date;
import java.util.Scanner;

public class AntiMalware {

    private static final String DIRECTORY_NAME = "AMDB";
    private static final File DATABASE_DIRECTORY =
            new File(System.getProperty("user.home") + File.separator + DIRECTORY_NAME);
    private static final String DATABASE_FILE_HEADER = "Prokopchuk";

    public static void main(String[] args) {
        IFileSystemGateway fileSystemGateway = new FileSystemGateway(DATABASE_DIRECTORY, DATABASE_FILE_HEADER);
        IDatabase database = new Database(fileSystemGateway);

        Scanner scanner = new Scanner(System.in);
        while (true) {
            System.out.print("Введите путь к файлу или директории: \n> ");
            String enter = scanner.nextLine();
            File path = new File(enter);
            if (path != null && path.exists()) {
                ScanReport scanReport = null;
                Date start = new Date();
                System.out.println("Сканирование...");
                if (path.isDirectory()) {
                    scanReport = new ScanSession(new Directory(path), database, Initiator.USER).start();
                } else if (path.isFile()) {
                    scanReport = new ScanSession(new FileObjectContent(path), database, Initiator.USER).start();
                }
                Date stop = new Date();
                float time = (stop.getTime() - start.getTime())/1000f;
                System.out.println("Сканирование окончено. Затрачено " + time + " сек.");
                if (scanReport != null && scanReport.getSuspects().size() > 0) {
                    System.out.println("Обнаружены следующие угрозы: ");
                    for (ScanObject scanObject : scanReport.getSuspects().keySet()) {
                        System.out.println("************************************");
                        System.out.println("Наименование объекта: " + scanObject.getName() + "\n" +
                                "Путь до объекта: " + scanObject.getPath());
                        System.out.println("************************************");
                    }
                } else {
                    System.out.println("Угроз не обнаружено.");
                }
            } else if (enter.equalsIgnoreCase("exit")) {
                System.out.println("Выход...");
                System.exit(0);
            } else {
                System.out.println("Ошибка ввода! Попробуйте ещё раз.");
            }
        }
    }
}
