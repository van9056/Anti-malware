package antimalware.database;

import antimalware.database.data.Suspect;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.nio.ByteBuffer;
import java.util.ArrayList;
import java.util.List;

public class FileSystemGateway implements IFileSystemGateway {

    private File directory;
    private String header;

    public FileSystemGateway(File directory, String header) {
        this.directory = directory;
        this.header = header;
    }

    @Override
    public List<Suspect> readSuspects() {
        List<Suspect> suspects = new ArrayList<>();
        if (directory.exists() && directory.isDirectory()) {
            File[] files = directory.listFiles();
            if (files != null && files.length > 0) {
                for (File file : files) {
                    if (file.isFile()) {
                        String fileExtension = getFileExtension(file.getName());
                        if (fileExtension != null && fileExtension.equalsIgnoreCase(".bin")) {
                            try (FileInputStream fin = new FileInputStream(file)) {
                                byte[] headerBytes = new byte[header.length()];
                                if (fin.read(headerBytes) != headerBytes.length)
                                    continue;
                                String h = new String(headerBytes);
                                if (h.equals(header)) {
                                    int nameLength, signLength, offsetMin, offsetMax;
                                    // Длина названия вируса
                                    nameLength = fin.read();
                                    // Размер сигнатуры вируса
                                    ByteBuffer byteBuffer = ByteBuffer.allocate(4);
                                    fin.read(byteBuffer.array());
                                    signLength = byteBuffer.getInt();
                                    byteBuffer.clear();
                                    // Минимальное смещение первого символа сигнатуры
                                    fin.read(byteBuffer.array());
                                    offsetMin = byteBuffer.getInt();
                                    byteBuffer.clear();
                                    // Максимальное смещение первого символа сигнатуры
                                    fin.read(byteBuffer.array());
                                    offsetMax = byteBuffer.getInt();
                                    // Название вируса
                                    byte[] nameBytes = new byte[nameLength];
                                    fin.read(nameBytes);
                                    String name = new String(nameBytes);
                                    // Сигнатура вируса
                                    byte[] signBytes = new byte[signLength];
                                    fin.read(signBytes);

                                    Suspect suspect = new Suspect(name, offsetMin, offsetMax, signBytes);
                                    suspects.add(suspect);
                                }
                            } catch (IOException e) {
                                e.printStackTrace();
                            }
                        }
                    }
                }
            }
        } else {
            directory.mkdir();
        }
        return suspects;
    }

    private String getFileExtension(String fileName) {
        int index = fileName.lastIndexOf('.');
        return index == -1 ? null : fileName.substring(index);
    }
}
